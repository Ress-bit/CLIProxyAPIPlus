services:
  cli-proxy-api:
    image: ${CLI_PROXY_IMAGE:-eceasy/cli-proxy-api-plus:latest}
    pull_policy: always
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-none}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    container_name: cli-proxy-api-plus
    environment:
      # Cloud deploy mode - allows server to start without config.yaml
      DEPLOY: cloud
      
      # Management password - set this in Dokploy Environment Variables UI
      MANAGEMENT_PASSWORD: ${MANAGEMENT_PASSWORD}
      
      # Auto-enable streaming optimization (default: true for cloud deployments)
      # Set to "false" to disable automatic streaming config injection
      # When enabled, adds:
      #   - keepalive-seconds: 15 (prevents proxy/load balancer timeouts)
      #   - bootstrap-retries: 1 (improves connection reliability)
      ENABLE_STREAMING: ${ENABLE_STREAMING:-true}
      
      # Usage statistics - set to "false" to disable permanently
      # This overrides config.yaml and persists across redeploys
      # Leave unset to use config.yaml value (default: true)
      # USAGE_STATISTICS_ENABLED: ${USAGE_STATISTICS_ENABLED}
    ports:
      - "8317:8317"
      - "8085:8085"
      - "1455:1455"
      - "54545:54545"
      - "51121:51121"
      - "11451:11451"
    volumes:
      # Use named volumes for persistence in Dokploy
      - cliproxy_auths:/root/.cli-proxy-api
      - cliproxy_logs:/CLIProxyAPI/logs
      # config.yaml mount - persists API keys and settings
      - cliproxy_config:/CLIProxyAPI/config
    restart: unless-stopped

volumes:
  cliproxy_auths:
  cliproxy_logs:
  cliproxy_config:
