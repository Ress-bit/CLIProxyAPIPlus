services:
  cli-proxy-api:
    image: ${CLI_PROXY_IMAGE:-eceasy/cli-proxy-api-plus:latest}
    pull_policy: always
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-none}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    environment:
      # Cloud deploy mode - allows server to start without config.yaml
      DEPLOY: cloud
      
      # Management password - set this in Dokploy Environment Variables UI
      MANAGEMENT_PASSWORD: ${MANAGEMENT_PASSWORD}
      
      # Auto-enable streaming optimization (default: true for cloud deployments)
      # Set to "false" to disable automatic streaming config injection
      # When enabled, adds:
      #   - keepalive-seconds: 15 (prevents proxy/load balancer timeouts)
      #   - bootstrap-retries: 1 (improves connection reliability)
      ENABLE_STREAMING: ${ENABLE_STREAMING:-true}
      
      # Usage statistics - set to "false" to disable permanently
      # This overrides config.yaml and persists across redeploys
      # Leave unset to use config.yaml value (default: true)
      # USAGE_STATISTICS_ENABLED: ${USAGE_STATISTICS_ENABLED}
    ports:
      - "8317:8317"
      - "8085:8085"
      - "1455:1455"
      - "54545:54545"
      - "51121:51121"
      - "11451:11451"
    volumes:
      # ============================================================================
      # CRITICAL VOLUMES - DO NOT DELETE THESE VOLUMES ON REDEPLOY!
      # ============================================================================
      
      # Auth tokens and OAuth credentials (Google, Claude, Codex, etc.)
      # Location: /root/.cli-proxy-api/
      # Contains: *.token.json files with OAuth refresh tokens
      # NEVER delete this volume or all users will need to re-authenticate!
      - cliproxy_auths:/root/.cli-proxy-api
      
      # Application logs and usage statistics
      # Location: /CLIProxyAPI/logs/
      # Contains: Application logs and usage tracking data
      # Safe to delete if you want to reset logs, but usage stats will be lost
      - cliproxy_logs:/CLIProxyAPI/logs
      
      # Configuration persistence
      # Location: /data/config.yaml (symlinked to /CLIProxyAPI/config.yaml)
      # Contains: config.yaml with API keys, settings, and all configuration
      # The entrypoint script auto-creates config.yaml from config.example.yaml
      # on first run and creates a symlink at /CLIProxyAPI/config.yaml
      # This approach ensures the config persists while not overriding the binary
      - cliproxy_config:/data
      
    restart: unless-stopped

volumes:
  # Named volumes for data persistence in Dokploy
  # These volumes will persist even when containers are recreated/redeployed
  # DO NOT delete these volumes unless you want to lose all data!
  cliproxy_auths:
  cliproxy_logs:
  cliproxy_config:

